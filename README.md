# Market Regime Detection via MMD

A Python implementation of market regime detection using Maximum Mean Discrepancy (MMD) with kernel methods.

## Overview

This project applies sliding window MMD two-sample tests to detect distributional regime changes in financial returns. Detected boundaries are validated against known market events (e.g., COVID-19 crash, 2022 drawdown).

## Features

- **MMD-based detection**: Nonparametric detection of distributional shifts
- **Permutation testing**: Statistical significance via permutation null distribution
- **Multiple kernels**: RBF, polynomial, and linear kernel support
- **Rich feature engineering**: Log OHLCV, intraday shape, volatility structure, and more
- **Visualization**: Multi-panel regime detection plots with boundary annotation

## Installation

```bash
# Clone the repository
git clone https://github.com/whitham-powell/regime-detection.git
cd regime-detection

# If using uv (recommended)
uv sync
make env

# Or with standard pip
pip install -e ".[dev]"
```

## Quick Start

```python
import numpy as np
from kta import rbf
from regime_detection import (
    make_features,
    sliding_window_mmd,
    results_to_dataframe,
    find_regime_boundaries,
    plot_regime_detection_panel,
)
from sklearn.preprocessing import StandardScaler

# Load and prepare features
features = make_features("base")
scaler = StandardScaler()
signal = scaler.fit_transform(features.values)

# Compute kernel bandwidth
sigma = np.median(np.abs(signal - np.median(signal)))
gamma = 1.0 / (2 * sigma**2)

# Run sliding window MMD
results = sliding_window_mmd(
    data=signal,
    kernel_fn=rbf,
    kernel_params={"gamma": gamma},
    window=30,
    step=5,
    n_permutations=500,
)

# Convert to DataFrame and find boundaries
results_df = results_to_dataframe(results, features.index)
boundaries = find_regime_boundaries(results_df, threshold=10.0)

# Plot results
from regime_detection import df  # price data
plot_regime_detection_panel(df["Close"], results_df)
```

## Project Structure

```
regime-detection/
├── src/regime_detection/    # Core implementation
│   ├── __init__.py         # Package exports
│   ├── mmd.py              # MMD computation and sliding window
│   ├── features.py         # Feature engineering from OHLCV
│   └── plots.py            # Visualization functions
├── notebooks/              # Example notebooks
│   ├── demo.py            # Main demonstration (synced to .ipynb)
│   └── experiments/       # Comparison experiments
│       └── kernel_comparison.py
├── tests/                  # Unit tests
├── extracted_figures/      # Generated by `make plots`
├── Makefile               # Development commands
├── pyproject.toml         # Package configuration
└── README.md
```

## Notebooks

1. **Demo** (`notebooks/demo.py`): Main regime detection demonstration with RBF kernel
2. **Kernel Comparison** (`notebooks/experiments/kernel_comparison.py`): Compare RBF, polynomial, and linear kernels

### Running Examples

```bash
# Run all tests
make test

# Extract figures from notebooks
make plots

# Convert notebooks to markdown
make md

# Sync .py <-> .ipynb via jupytext
make sync
```

## API Reference

### Core Functions

- `mmd_squared(X, Y, kernel_fn, kernel_params)`: Compute MMD² between samples
- `mmd_permutation_test(X, Y, ...)`: MMD with permutation test for p-value
- `sliding_window_mmd(data, ...)`: Scan time series for regime changes

### Feature Engineering

- `make_features(group_names)`: Build feature matrix from named groups
- Available groups: `'base'`, `'intraday_shape'`, `'cross_day'`, `'vol_structure'`, `'all'`

### Visualization

- `plot_regime_detection_panel(price, results_df)`: 4-panel figure (price, MMD, std, KTA)
- `plot_regime_boundaries_summary(price, results_df, boundaries)`: Price with annotated boundaries
- `find_regime_boundaries(results_df, threshold)`: Extract boundary dates from results

## Dependencies

- [kernel-target-alignment](https://github.com/whitham-powell/kernel-target-alignment): Kernel functions and KTA computation
- numpy, pandas, matplotlib, scikit-learn, scipy, yfinance

## References

- Gretton, A., Borgwardt, K., Rasch, M., Schölkopf, B., & Smola, A. (2012). A Kernel Two-Sample Test. *Journal of Machine Learning Research*, 13:723–773.
- Muandet, K., Fukumizu, K., Sriperumbudur, B., & Schölkopf, B. (2017). Kernel Mean Embedding of Distributions: A Review and Beyond. *Foundations and Trends in Machine Learning*, 10(1–2):1–141.

## License

MIT License

## Acknowledgments

Developed as part of STAT 673 coursework at Portland State University.
